<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Turno</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container-admin">
        <h1>Reserva tu Turno</h1>
        <div class="filtros" style="display: block; text-align: left;">
            <input type="text" id="nombre" placeholder="Nombre Completo" style="width:100%; margin-bottom:10px;">
            <input type="text" id="dni" placeholder="DNI" style="width:100%; margin-bottom:10px;">
            <select id="tipo" onchange="cargarHorariosDisponibles()" style="width:100%; margin-bottom:10px; height:48px; border-radius:12px; border:1px solid #dadce0; padding:10px;">
                <option value="Control">Control (20 min)</option>
                <option value="Primera vez">Primera vez (40 min)</option>
            </select>
            <input type="date" id="fecha" onchange="cargarHorariosDisponibles()" style="width:100%; margin-bottom:15px;">

            <label style="font-size:14px; color:#555;">Horarios disponibles:</label>
            <div id="gridHorarios" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px;">
                </div>
            <input type="hidden" id="horaSeleccionada">

            <button onclick="reservarTurno()" class="btn-buscar" style="width: 100%; margin-top: 25px;">Confirmar Reserva</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const _supabase = supabase.createClient('https://uekuyjoakqnhjltqrrpj.supabase.co', 'sb_publishable_COB2p3O_OrgFdO3W6EvLvg_DuicBhwj');

        async function cargarHorariosDisponibles() {
            const fecha = document.getElementById('fecha').value;
            const grid = document.getElementById('gridHorarios');
            if (!fecha) return;

            grid.innerHTML = ' Cargando...';
            const { data: ocupados } = await _supabase.from('turnos').select('hora_inicio, hora_fin').eq('fecha', fecha);
            
            grid.innerHTML = '';
            for (let h = 15; h < 20; h++) {
                for (let m = 0; m < 60; m += 20) {
                    const hora = `${h}:${m === 0 ? '00' : m}`;
                    const yaTomado = ocupados?.some(t => t.hora_inicio.startsWith(hora));

                    if (!yaTomado) {
                        const btn = document.createElement('div');
                        btn.innerText = hora;
                        btn.className = "slot-hora";
                        btn.onclick = () => {
                            document.querySelectorAll('.slot-hora').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            document.getElementById('horaSeleccionada').value = hora;
                        };
                        grid.appendChild(btn);
                    }
                }
            }
        }

        async function reservarTurno() {
            const nombre = document.getElementById('nombre').value;
            const dni = document.getElementById('dni').value;
            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('horaSeleccionada').value;
            const tipo = document.getElementById('tipo').value;

            if (!nombre || !dni || !fecha || !hora) return alert("Completa todos los datos");

            const { error } = await _supabase.from('turnos').insert([{
                nombre, dni, fecha, hora_inicio: hora, 
                hora_fin: (tipo === 'Control' ? hora : hora), // Simplificado para el ejemplo
                tipo_turno: tipo
            }]);

            if (error) alert(error.message);
            else { alert("Reserva exitosa"); location.reload(); }
        }
    </script>
</body>
</html>
