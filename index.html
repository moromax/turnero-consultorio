<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Turno</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container-admin">
        <h1 style="text-align:center;">Reserva tu Turno</h1>
        
        <div class="filtros" style="display: flex; flex-direction: column; background: none; padding: 0;">
            <label>Nombre Completo:</label>
            <input type="text" id="nombre" placeholder="Ej: Juan Pérez" style="width:100%; margin-bottom:15px;">
            
            <label>DNI (solo números, 7 u 8 cifras):</label>
            <input type="text" id="dni" placeholder="Ej: 12345678" style="width:100%; margin-bottom:15px;">
            
            <label>Tipo de Turno:</label>
            <select id="tipo" onchange="cargarHorarios()" style="width:100%; margin-bottom:15px;">
                <option value="Control">Control (20 min)</option>
                <option value="Primera vez">Primera vez (40 min)</option>
            </select>
            
            <label>Fecha:</label>
            <input type="date" id="fecha" onchange="cargarHorarios()" style="width:100%; margin-bottom:15px;">

            <p style="font-size: 14px; margin: 10px 0; color: #5f6368;">Selecciona un Horario:</p>
            <div id="gridHorarios" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; width: 100%;"></div>
            
            <input type="hidden" id="horaSeleccionada">

            <button onclick="reservar()" class="btn-buscar" style="width:100%; margin-top:30px; font-size: 16px;">Confirmar Reserva</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de tu proyecto
        const SUPABASE_URL = 'https://uekuyjoakqnhjltqrrpj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_COB2p3O_OrgFdO3W6EvLvg_DuicBhwj';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function cargarHorarios() {
            const fecha = document.getElementById('fecha').value;
            const grid = document.getElementById('gridHorarios');
            if (!fecha) return;

            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Buscando disponibilidad...</p>';
            
            // 1. Obtener turnos existentes para esta fecha
            const { data: ocupados, error } = await _supabase
                .from('turnos')
                .select('hora_inicio, hora_fin')
                .eq('fecha', fecha);
            
            if (error) {
                grid.innerHTML = 'Error al cargar horarios.';
                return;
            }

            grid.innerHTML = '';
            
            // 2. Generar slots cada 20 minutos (15:00 a 20:00)
            for (let h = 15; h < 20; h++) {
                for (let m = 0; m < 60; m += 20) {
                    const horaActual = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    
                    // 3. LOGICA DE SOLAPAMIENTO CORREGIDA
                    // Un slot está libre si la hora NO está entre el inicio (inclusive) y el fin (exclusive) de otro turno.
                    const estaOcupado = ocupados?.some(t => {
                        const inicioExistente = t.hora_inicio.substring(0, 5);
                        const finExistente = t.hora_fin.substring(0, 5);
                        return (horaActual >= inicioExistente && horaActual < finExistente);
                    });

                    if (!estaOcupado) {
                        const div = document.createElement('div');
                        div.className = 'slot-hora';
                        div.innerText = horaActual;
                        div.onclick = () => {
                            // Resaltar selección
                            document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('active'));
                            div.classList.add('active');
                            document.getElementById('horaSeleccionada').value = horaActual;
                        };
                        grid.appendChild(div);
                    }
                }
            }
        }

        async function reservar() {
            const nombre = document.getElementById('nombre').value;
            const dni = document.getElementById('dni').value;
            const fecha = document.getElementById('fecha').value;
            const hIni = document.getElementById('horaSeleccionada').value;
            const tipo = document.getElementById('tipo').value;

            if (!nombre || !dni || !fecha || !hIni) {
                alert("Por favor, completa todos los campos y selecciona un horario.");
                return;
            }

            // 4. CALCULO DE HORA_FIN AUTOMATICO
            const [h, m] = hIni.split(':').map(Number);
            const duracion = (tipo === 'Primera vez') ? 40 : 20;
            const finDate = new Date(0, 0, 0, h, m + duracion);
            const hFin = `${finDate.getHours().toString().padStart(2, '0')}:${finDate.getMinutes().toString().padStart(2, '0')}`;

            // 5. DOBLE VERIFICACION (Evita que dos personas reserven el mismo slot a la vez)
            const { data: colision } = await _supabase
                .from('turnos')
                .select('id')
                .eq('fecha', fecha)
                .eq('hora_inicio', hIni);

            if (colision && colision.length > 0) {
                alert("Lo sentimos, este horario acaba de ser reservado. Por favor, elige otro.");
                return cargarHorarios();
            }

            // 6. INSERCIÓN EN LA BASE DE DATOS
            const { error } = await _supabase.from('turnos').insert([{
                nombre: nombre,
                dni: dni,
                fecha: fecha,
                hora_inicio: hIni,
                hora_fin: hFin,
                tipo_turno: tipo
            }]);

            if (error) {
                // Manejo de error de validación de DNI en Supabase
                if (error.message.includes('turnos_dni_check')) {
                    alert("DNI inválido. Debe contener entre 7 y 8 números.");
                } else {
                    alert("Error al reservar: " + error.message);
                }
            } else {
                alert("✅ ¡Turno reservado con éxito!");
                location.reload(); // Recargar para limpiar el formulario
            }
        }
    </script>
</body>
</html>
