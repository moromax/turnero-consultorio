// Sustituye solo estas funciones dentro de tu index.html

async function cargarHorarios() {
    const fecha = document.getElementById('fecha').value;
    const grid = document.getElementById('gridHorarios');
    if (!fecha) return;

    grid.innerHTML = 'Verificando...';
    
    // Traemos los turnos del día
    const { data: ocupados } = await _supabase
        .from('turnos')
        .select('hora_inicio, hora_fin')
        .eq('fecha', fecha);
    
    grid.innerHTML = '';
    
    for (let h = 15; h < 20; h++) {
        for (let m = 0; m < 60; m += 20) {
            const horaActual = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            
            // LÓGICA CORREGIDA: Un horario está ocupado solo si la hora actual 
            // es MAYOR O IGUAL al inicio Y MENOR al fin del turno existente.
            // Esto permite que si un turno termina a las 15:40, las 15:40 esté LIBRE.
            const estaOcupado = ocupados?.some(t => {
                const inicio = t.hora_inicio.substring(0, 5);
                const fin = t.hora_fin.substring(0, 5);
                return (horaActual >= inicio && horaActual < fin);
            });

            if (!estaOcupado) {
                const div = document.createElement('div');
                div.className = 'slot-hora'; // Mantiene tu clase de CSS actual
                div.innerText = horaActual;
                div.onclick = () => {
                    document.querySelectorAll('.slot-hora').forEach(s => s.classList.remove('active'));
                    div.classList.add('active');
                    document.getElementById('horaSeleccionada').value = horaActual;
                };
                grid.appendChild(div);
            }
        }
    }
}

async function reservar() {
    const nombre = document.getElementById('nombre').value;
    const dni = document.getElementById('dni').value;
    const fecha = document.getElementById('fecha').value;
    const hIni = document.getElementById('horaSeleccionada').value;
    const tipo = document.getElementById('tipo').value;

    if (!nombre || !dni || !fecha || !hIni) return alert("Por favor, completa todos los campos.");

    // Cálculo automático de hora_fin para evitar solapamientos
    const [h, m] = hIni.split(':').map(Number);
    const duracion = tipo === 'Primera vez' ? 40 : 20;
    const dFin = new Date(0,0,0, h, m + duracion);
    const hFin = `${dFin.getHours().toString().padStart(2,'0')}:${dFin.getMinutes().toString().padStart(2,'0')}`;

    // Verificación de último segundo antes de insertar
    const { data: choque } = await _supabase.from('turnos')
        .select('id')
        .eq('fecha', fecha)
        .eq('hora_inicio', hIni);

    if (choque && choque.length > 0) {
        alert("Este horario ya no está disponible.");
        return cargarHorarios();
    }

    const { error } = await _supabase.from('turnos').insert([{
        nombre, dni, fecha, hora_inicio: hIni, hora_fin: hFin, tipo_turno: tipo
    }]);

    if (error) {
        // Traducimos el error del DNI al español
        if (error.message.includes('turnos_dni_check')) alert("El DNI debe tener 7 u 8 números.");
        else alert("Error: " + error.message);
    } else {
        alert("✅ Turno reservado correctamente.");
        location.reload();
    }
}
